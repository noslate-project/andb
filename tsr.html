<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
<html><head>
<style type="text/css"><!--
body {background-color: #ffffff; color: #000000;}
body, td, th, h1, h2, h3 {font-family: sans-serif;}
pre {margin: 0px; font-family: monospace;}
a:link {color: #000099; text-decoration: none; background-color: #ffffff;}
a:hover {text-decoration: underline;}
table {border-collapse: collapse;}
.center {text-align: center;}
.center table { margin-left: auto; margin-right: auto; text-align: left;}
.center th { text-align: center !important; }
td, th { border: 1px solid #000000; font-size: 75%; vertical-align: baseline; min-width: 30px;}
h1 {font-size: 150%;}
h2 {font-size: 125%;}
h3 {font-size: 100%;}
.p {text-align: left;}
.e {background-color: #ccccff; font-weight: bold; color: #000000;}
.h {background-color: #9999cc; font-weight: bold; color: #000000;}
.v {background-color: #cccccc; color: #000000;}
i {color: #666666; background-color: #cccccc;}
img {float: right; border: 0px;}
hr {width: 600px; background-color: #cccccc; border: 0px; height: 1px; color: #000000;}
//--></style>
<title>Noslate Debugger Report</title></head>
<body><div class="center">
<table border="0" cellpadding="3" width="600">
<tr class="h"><td>
<a href="https://noslate.midwayjs.org/"><img border="0" src="https://noslate.midwayjs.org/img/logo.svg" alt="Noslate Logo" width="48"/></a><h1 class="p">Noslate Debugger Corefile Report</h1>
</td></tr>
</table><br />
<div id="load-box" style="display:none">
<table border="0" cellpadding="3" width="600">
<tr class="h">
<td class="e"><label for="tsr-input" id="tsr-input-label">Load report</label></td>
<td class="v"><input type="file" id="tsr-input" accept=".tsr" /></td>
</tr>
</table><br />
</div>
<div id="contents"></div>
<br />
<table border="0" cellpadding="3" width="600">
<tr class="v"><td>
<p> The report file was generated by Noslate Debugger.
</p>
<p> https://noslate.midwayjs.org
</p>
</td></tr>
</table><br />
</div></body>

<script type="text/javascript">
const urlParams = new URLSearchParams(window.location.search);
const tsr_url = urlParams.get('tsr')
if (tsr_url != null) {
    document.querySelector("#contents").innerHTML = "<p>loading...</p>";
    document.querySelector("#contents").style.display = 'block';
    fetch(tsr_url).then(response => response.text()).then((text) => {
        document.querySelector("#contents").innerHTML = LoadTsr(text);
    });
    /*.catch(rejected => {
        console.log('failed to fetch tsr URL');
        document.querySelector("#contents").innerHTML = "<p>tsr not loaded.</p>";
        document.querySelector("#contents").style.display = 'block';
    })*/
} else {
    document.querySelector("#load-box").style.display = 'block';
}

function thX(...v) {
    let html = '<tr class="h">';
    v.forEach((el) => {
        html += '<th class="">' + el + '</th>'
    });
    return html + '</tr>';
}

function tdX(name, ...v) {
    let html = '<tr><td class="e">' + name + '</td>'
    v.forEach(el => {
        html += '<td class="v">' + el + '</td>'
    });
    return html + '</tr>';
}

function xp(tsr, path, def=undefined) {
    let x = tsr;
    try {
        path.split('/').forEach((v) => {
            x = x[v]
        });
        return x;
    } catch (e) {
        // nothing
    } 
    return def;
}

function escapeHtml(unsafe) {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
 }

 class TSR {
    constructor(txt) {
        this.tsr = JSON.parse(txt);
    }

    _list(root, blk, title=undefined) {
        let html = '';
    }

    _dict(tsr, blk) {
        let html = '';
        let o = tsr[blk];
        Object.keys(o).sort().forEach((k) =>{
            if (Object.prototype.toString.call(o[k]) === '[object Object]') {
                html += this._dict(o, k);
            } else if (Array.isArray(o[k])) {
                html += this._list(o, k);
            } else {
                html += tdX(k, o[k]);
            }
        });
        return html;
    }

    rDict(tsr, blk) {
        if (!(blk in tsr)) {
            return ""; 
        }
        let title = blk;
        let html = `<a name="${title}"></a>`;
        html += `<h2>${title}</h2>`;
        html += '<table border="0" cellpadding="3" width="600">';
        html += this._dict(tsr, blk);
        html += '</table><br />';
        return html;       
    }

    rCoreNtFiles() {
        const x = xp(this.tsr, 'core/files', []);
        let html = '<a name="nt-files"></a>';
        html += '<h2>NT-FILES</h2>';
        html += '<table border="0" cellpadding="3" width="600">';
        html += thX('', 'start_addr', 'end_addr', 'name', 'build_id');
        x.forEach((el, idx) => {
            html += tdX(idx, el['start_addr'].toString(16), el['end_addr'].toString(16), el['name'], el['build_id']);
        });
        html += '</table><br />';
        return html;
    }

    rCoreMMap() {
        const x = xp(this.tsr, 'core/mmap', []);
        let html = '<a name="core-mmap"></a>';
        html += '<h2>mmap</h2>';
        html += '<table border="0" cellpadding="3" width="800">';
        html += thX('#', 'start_addr', 'end_addr', 'flag', 'type', 'size', 'note');
        const flag_str = (v) => {
            let out = "";
            out += v&4 ? 'r' : '-'; 
            out += v&2 ? 'w' : '-'; 
            out += v&1 ? 'x' : '-'; 
            out += v&8 ? 's' : 'p'; 
            return out;
        };
        x.forEach((el,idx) => {
            let end_addr = el['p_vaddr'] + el['p_memsz'];
            html += tdX(idx, el['p_vaddr'].toString(16), end_addr.toString(16), flag_str(el['p_flags']),  el['p_type'], el['p_memsz'], '');
        }); 
        html += '</table><br />';
        return html;
    }

    rCore() {
        if (!('core' in this.tsr)) {
            return;
        }
        const core = this.tsr['core'];
        let html = '<a name="core"></a>';
        html += '<h1>Corefile details</h1>';
        html += this.rDict(core, 'siginfo');
        html += this.rDict(core, 'prstatus');
        html += this.rDict(core, 'prpsinfo');
        html += this.rCoreNtFiles();
        html += this.rCoreMMap();
        return html;
    }

    rFile() {
        const tsr = this.tsr;
        let html = '<a name="tsr"></a>';
        html += '<h1>' + tsr['tsr_file'] + '</h1>';
        html += '<table border="0" cellpadding="3" width="600">';
        html += tdX('Create Time', tsr['create_time']);
        html += tdX('File Name', tsr['file']['name']);
        html += tdX('File Size', tsr['file']['size']);
        html += tdX('File MD5', tsr['file']['md5']);
        html += '</table><br />';
        return html;
    }
   
    rAndbNodeVersion() {
        return this.rDict(this.tsr['andb'], 'node_version');
    }

    rAndbV8BackTrace() {
        const x = xp(this.tsr, 'andb/frames', []);
        let html = '<a name="v8_bt"></a>';
        html += '<h2>V8 Backtrace</h2>';
        html += '<table border="0" cellpadding="3" width="800">';
        html += thX('#', 'pc',  'function', 'sp');
        const desc_str = (v) => {
            let fName = v['function_name'];
            if (fName == null || fName == "") {
                fName = "(anonymous)";
            }
            let sArgs = "";
            v['args'].forEach((el, idx) => {
                if (idx != 0) {
                    sArgs += ", ";
                }
                sArgs += el[0] + "=" + el[1];
                console.log(el[1])
            });
            let sPos = "";
            if (v['position'] && v['position'][0] != null) {
                sPos = 'at ' + v['position'][0] + ':' + v['position'][1];
            }
            if (fName[0] == '<') {
                return fName;
            }
            return `${fName} (${sArgs}) ${sPos}`;
        };

        x.forEach((el, idx) => {
            let desc = escapeHtml(desc_str(el));
            html += tdX(`#${idx} `, el['pc'].toString(16), desc, el['sp'].toString(16));
        });
        html += '</table><br />';
        return html;
    }

    rAndbEnviron() {
        const x = xp(this.tsr, 'andb/environ', []);
        let html = '<a name="environ"></a>';
        html += '<h2>Environ Variables</h2>';
        html += '<table border="0" cellpadding="3" style="word-wrap:break-word; word-break:break-all;" width="800">';
        x.forEach((el, idx) => {
            html += tdX(idx, el);
        });
        html += '</table><br />';
        return html;
    }

    rAndb() {
        const tsr = this.tsr;
        let html = '<a name="andb"></a>';
        html += '<h1>Andb reveal</h1>';
        html += this.rAndbV8BackTrace();
        html += this.rAndbEnviron();
        return html;
    }
}

function LoadTsr(txt) {
    var html = '<table border="0" cellpadding="3" width="600">';
    tsr = new TSR(txt);
    html += tsr.rFile();
    html += tsr.rAndbNodeVersion();
    html += tsr.rAndb();
    html += tsr.rCore();
    return html;
}

document.querySelector("#tsr-input").addEventListener('change', function() {
    // files that user has chosen
    var files = this.files;
    if (files.length == 0) {
        alert('No file selected');
        return;
    }

    var file = files[0];
    var reader = new FileReader();
    reader.addEventListener('load', function(e) {
        var text = e.target.result;
        document.querySelector("#contents").innerHTML = LoadTsr(text);
        document.querySelector("#contents").style.display = 'block';
        document.querySelector("#tsr-input-label").style.display = 'block'; 
        document.querySelector("#load-box").style.display = 'none';
    });

    reader.addEventListener('error', function() {
        alert('Failed to read file.');
    });
    
    reader.readAsText(file);
});
</script>
</html> 
